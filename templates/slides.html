<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提案資料 - スライドショー</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/dist/reveal.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/dist/theme/white.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
    <style>
        .reveal {
            font-family: 'Helvetica Neue', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
        }
        .reveal h1, .reveal h2, .reveal h3 {
            color: #1a1a2e;
            font-weight: 700;
            text-transform: none;
        }
        .reveal h2 {
            font-size: 1.6em;
            margin-bottom: 0.5em;
        }
        .reveal .slide-content {
            text-align: left;
            font-size: 0.65em;
            line-height: 1.7;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
        }
        .reveal .slide-content ul,
        .reveal .slide-content ol {
            display: block;
            margin-left: 1em;
        }
        .reveal .slide-content li {
            margin-bottom: 0.4em;
        }
        .reveal .slide-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
            font-size: 0.9em;
        }
        .reveal .slide-content th,
        .reveal .slide-content td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        .reveal .slide-content th {
            background: #2563eb;
            color: #fff;
            font-weight: 600;
        }
        .reveal .slide-content tr:nth-child(even) {
            background: #f8fafc;
        }
        .reveal .slide-content strong {
            color: #2563eb;
        }
        .reveal section.cover-slide {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .reveal section.cover-slide h1 {
            font-size: 2em;
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 0.3em;
        }
        .reveal .type-badge {
            display: inline-block;
            padding: 3px 12px;
            border-radius: 20px;
            font-size: 0.45em;
            font-weight: 600;
            margin-bottom: 0.5em;
            color: #fff;
        }
        .badge-analysis { background: #ef4444; }
        .badge-proposal { background: #22c55e; }
        .badge-flow { background: #f59e0b; }
        .badge-pricing { background: #8b5cf6; }
        .badge-summary { background: #6366f1; }
        /* Mermaid図コンテナ */
        .reveal .slide-content .mermaid-container {
            display: flex;
            justify-content: center;
            margin: 0.8em 0;
        }
        .reveal .slide-content .mermaid-container svg {
            max-width: 100%;
            max-height: 400px;
        }
        /* Chart.jsグラフコンテナ */
        .reveal .slide-content .chart-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            height: 350px;
            margin: 0.8em auto;
        }
        .reveal .slide-content .chart-container canvas {
            max-width: 100%;
            max-height: 100%;
        }
        .reveal .controls { color: #2563eb; }
        .reveal .progress { color: #2563eb; height: 4px; }
        .top-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 100;
            background: rgba(255,255,255,0.95);
            border-bottom: 1px solid #e5e7eb;
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .top-bar a {
            color: #2563eb;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
        }
        .top-bar .page-info {
            font-size: 13px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="/">&#8592; 戻る</a>
        <span class="page-info" id="pageInfo"></span>
    </div>
    <div class="reveal">
        <div class="slides" id="slidesContainer">
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/dist/reveal.js"></script>
    <script>
        const BADGE_MAP = {
            analysis: ['市場環境分析', 'badge-analysis'],
            proposal: ['新ターゲット提案', 'badge-proposal'],
            flow: ['営業フロー', 'badge-flow'],
            pricing: ['支援範囲', 'badge-pricing'],
            summary: ['まとめ', 'badge-summary']
        };

        // Mermaid初期化（手動レンダリングモード）
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose',
            fontFamily: 'Helvetica Neue, Hiragino Sans, Noto Sans JP, sans-serif'
        });

        let chartCounter = 0;
        let mermaidCounter = 0;

        /**
         * marked.parse()の出力HTMLから mermaid/chart コードブロックを検出し、
         * 描画用コンテナに差し替える
         */
        function preprocessContent(html) {
            const temp = document.createElement('div');
            temp.innerHTML = html;
            const mermaidBlocks = [];
            const chartBlocks = [];

            const codeBlocks = temp.querySelectorAll('pre code');
            codeBlocks.forEach(code => {
                const pre = code.parentElement;
                if (code.classList.contains('language-mermaid')) {
                    const id = 'mermaid-' + (mermaidCounter++);
                    const container = document.createElement('div');
                    container.className = 'mermaid-container';
                    container.id = id;
                    mermaidBlocks.push({ id: id, code: code.textContent.trim() });
                    pre.replaceWith(container);
                } else if (code.classList.contains('language-chart')) {
                    const id = 'chart-' + (chartCounter++);
                    const container = document.createElement('div');
                    container.className = 'chart-container';
                    const canvas = document.createElement('canvas');
                    canvas.id = id;
                    container.appendChild(canvas);
                    chartBlocks.push({ id: id, config: code.textContent.trim() });
                    pre.replaceWith(container);
                }
            });

            return { html: temp.innerHTML, mermaidBlocks, chartBlocks };
        }

        /** Mermaid図をSVGとして描画 */
        async function renderMermaidBlocks(blocks) {
            for (const block of blocks) {
                try {
                    const { svg } = await mermaid.render(block.id + '-svg', block.code);
                    const el = document.getElementById(block.id);
                    if (el) el.innerHTML = svg;
                } catch (e) {
                    console.error('Mermaid render error:', e);
                    const el = document.getElementById(block.id);
                    if (el) el.innerHTML = '<pre style="color:#ef4444;font-size:0.8em;">Mermaid図の描画エラー</pre>';
                }
            }
        }

        /** Chart.jsグラフを描画 */
        function renderChartBlocks(blocks) {
            blocks.forEach(block => {
                try {
                    const config = JSON.parse(block.config);
                    config.options = config.options || {};
                    config.options.responsive = true;
                    config.options.maintainAspectRatio = true;
                    const canvas = document.getElementById(block.id);
                    if (canvas) new Chart(canvas.getContext('2d'), config);
                } catch (e) {
                    console.error('Chart.js render error:', e);
                    const canvas = document.getElementById(block.id);
                    if (canvas && canvas.parentElement) {
                        canvas.parentElement.innerHTML = '<pre style="color:#ef4444;font-size:0.8em;">グラフの描画エラー</pre>';
                    }
                }
            });
        }

        async function buildSlides() {
            const raw = sessionStorage.getItem('slides');
            if (!raw) {
                window.location.href = '/';
                return;
            }
            const slides = JSON.parse(raw);
            const container = document.getElementById('slidesContainer');

            const allMermaidBlocks = [];
            const allChartBlocks = [];

            slides.forEach(slide => {
                const section = document.createElement('section');
                const rawHtml = marked.parse(slide.content || '');
                const { html: contentHtml, mermaidBlocks, chartBlocks } = preprocessContent(rawHtml);

                allMermaidBlocks.push(...mermaidBlocks);
                allChartBlocks.push(...chartBlocks);

                if (slide.type === 'cover') {
                    section.classList.add('cover-slide');
                    section.innerHTML = `<h1>${slide.title}</h1><div class="slide-content">${contentHtml}</div>`;
                } else {
                    const badge = BADGE_MAP[slide.type];
                    const badgeHtml = badge
                        ? `<span class="type-badge ${badge[1]}">${badge[0]}</span>`
                        : '';
                    section.innerHTML = `
                        ${badgeHtml}
                        <h2>${slide.title}</h2>
                        <div class="slide-content">${contentHtml}</div>
                    `;
                }
                container.appendChild(section);
            });

            // reveal.jsを初期化（DOMレイアウト確定後に図表を描画するため）
            Reveal.initialize({
                hash: true,
                slideNumber: true,
                width: 1200,
                height: 700,
                margin: 0.08,
                transition: 'slide',
                controls: true,
                progress: true,
                center: false,
            });

            Reveal.on('slidechanged', updatePageInfo);
            updatePageInfo();

            // reveal.js初期化後に図表を描画
            await renderMermaidBlocks(allMermaidBlocks);
            renderChartBlocks(allChartBlocks);

            // 図表描画後にレイアウトを再計算
            Reveal.layout();
        }

        function updatePageInfo() {
            const current = Reveal.getIndices().h + 1;
            const total = Reveal.getTotalSlides();
            document.getElementById('pageInfo').textContent = `${current} / ${total}`;
        }

        buildSlides();
    </script>
</body>
</html>
