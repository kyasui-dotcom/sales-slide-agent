<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>営業提案資料ジェネレーター</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

    <!-- ===== STEP 1: 入力画面 ===== -->
    <div class="container" id="stepInput">
        <div class="card">
            <div class="card-header">
                <h1>営業提案資料ジェネレーター</h1>
                <button class="btn-settings" id="btnSettings" title="設定">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
            </div>
            <p class="subtitle">商品情報を入力すると、AIが提案スライドを自動生成します</p>

            <div class="api-warning" id="apiWarning">
                <span>&#9888;</span> APIキーが未設定です。右上の歯車アイコンから設定してください。
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="url">URL</button>
                <button class="tab" data-tab="pdf">PDF</button>
                <button class="tab" data-tab="text">テキスト</button>
            </div>

            <form id="generateForm" enctype="multipart/form-data">
                <input type="hidden" name="input_type" id="inputType" value="url">

                <div class="tab-content active" id="tab-url">
                    <label for="url">商品ページのURL</label>
                    <input type="url" id="url" name="url" placeholder="https://example.com/product">
                </div>

                <div class="tab-content" id="tab-pdf">
                    <label for="pdfFile">商品資料PDF</label>
                    <div class="file-upload">
                        <input type="file" id="pdfFile" name="pdf_file" accept=".pdf">
                        <span class="file-label" id="fileLabel">クリックしてPDFを選択</span>
                    </div>
                </div>

                <div class="tab-content" id="tab-text">
                    <label for="textInput">商品情報をテキストで入力</label>
                    <textarea id="textInput" name="text_input" rows="10"
                        placeholder="商品名、特徴、ターゲット、価格帯、現在の課題など、できるだけ詳しく入力してください"></textarea>
                </div>

                <button type="submit" class="btn-generate" id="btnGenerate">
                    提案資料を生成
                </button>
            </form>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>AIが提案資料を生成しています...</p>
                <p class="loading-sub">30秒〜1分ほどお待ちください</p>
            </div>

            <div class="error" id="error"></div>
        </div>
    </div>

    <!-- ===== STEP 2: プレビュー・編集画面 ===== -->
    <div class="preview-container" id="stepPreview" style="display:none;">
        <div class="preview-header">
            <h2>生成結果プレビュー</h2>
            <p class="preview-subtitle">各スライドの内容を確認・編集してから、スライド化できます。</p>
        </div>

        <div class="preview-slides" id="previewSlides">
            <!-- JSで動的に生成 -->
        </div>

        <div class="preview-actions">
            <button class="btn-back" id="btnBackToInput">&#8592; 入力に戻る</button>
            <button class="btn-generate btn-to-slides" id="btnToSlides">この内容でスライド化 &#8594;</button>
        </div>
    </div>

    <!-- ===== 設定モーダル ===== -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal modal-wide">
            <div class="modal-header">
                <h2>設定</h2>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>

            <div class="modal-tabs">
                <button class="modal-tab active" data-modal-tab="apikey">APIキー</button>
                <button class="modal-tab" data-modal-tab="prompt">プロンプト</button>
            </div>

            <div class="modal-tab-content active" id="modal-tab-apikey">
                <div class="modal-body">
                    <label for="apiKeyInput">OpenAI APIキー</label>
                    <div class="api-key-field">
                        <input type="password" id="apiKeyInput" placeholder="sk-xxxxxxxxxxxxxxxx">
                        <button type="button" class="btn-toggle-visibility" id="btnToggleKey" title="表示/非表示">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                    <p class="api-key-hint">APIキーはブラウザのローカルストレージに保存されます。サーバーには保存されません。</p>
                    <div class="modal-actions">
                        <button class="btn-save" id="btnSaveKey">保存</button>
                        <button class="btn-delete" id="btnDeleteKey">削除</button>
                    </div>
                    <div class="api-key-status" id="apiKeyStatus"></div>
                </div>
            </div>

            <div class="modal-tab-content" id="modal-tab-prompt">
                <div class="modal-body">
                    <label for="promptTextarea">AIへの指示プロンプト（役割・思考プロセス・トーン）</label>
                    <p class="prompt-hint">AIの役割、分析の思考プロセス、出力のトーンを自由に調整できます。<br>スライドの構成ルール（JSON形式・枚数等）はシステム側で固定されているため、ここでは変更不要です。</p>
                    <textarea id="promptTextarea" class="prompt-editor" rows="16" placeholder="プロンプトを入力..."></textarea>
                    <div class="prompt-actions">
                        <button class="btn-save" id="btnSavePrompt">保存</button>
                        <button class="btn-reset" id="btnResetPrompt">デフォルトに戻す</button>
                    </div>
                    <div class="api-key-status" id="promptStatus"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === 状態管理 ===
        let currentSlides = [];

        const TYPE_LABELS = {
            cover: '表紙',
            analysis: '市場環境分析',
            proposal: '新ターゲット提案',
            flow: '営業フロー',
            pricing: '支援範囲と成果報酬',
            summary: 'まとめ'
        };

        // === デフォルトプロンプト管理 ===
        let defaultPrompt = '';
        let defaultPromptLoaded = false;

        async function fetchDefaultPrompt() {
            if (defaultPromptLoaded) return;
            try {
                const resp = await fetch('/api/default-prompt');
                const data = await resp.json();
                defaultPrompt = data.prompt;
                defaultPromptLoaded = true;
            } catch (e) {
                console.error('デフォルトプロンプト取得失敗:', e);
            }
        }
        const defaultPromptPromise = fetchDefaultPrompt();

        function getCustomPrompt() {
            return localStorage.getItem('custom_prompt') || '';
        }

        function getEffectivePrompt() {
            return getCustomPrompt() || defaultPrompt;
        }

        // === APIキー管理 ===
        function getApiKey() {
            return localStorage.getItem('openai_api_key') || '';
        }

        function updateApiWarning() {
            const warning = document.getElementById('apiWarning');
            warning.style.display = getApiKey() ? 'none' : 'flex';
        }

        updateApiWarning();

        // === 画面切替 ===
        function showStep(step) {
            document.getElementById('stepInput').style.display = step === 'input' ? '' : 'none';
            document.getElementById('stepPreview').style.display = step === 'preview' ? '' : 'none';
        }

        // === プレビュー画面を構築 ===
        function renderPreview(slides) {
            currentSlides = slides;
            const container = document.getElementById('previewSlides');
            container.innerHTML = '';

            slides.forEach((slide, i) => {
                const card = document.createElement('div');
                card.className = 'preview-card';

                const typeLabel = TYPE_LABELS[slide.type] || slide.type;

                card.innerHTML = `
                    <div class="preview-card-header">
                        <span class="preview-card-num">${i + 1}</span>
                        <span class="preview-card-type type-${slide.type}">${typeLabel}</span>
                    </div>
                    <div class="preview-field">
                        <label>タイトル</label>
                        <input type="text" class="preview-title-input" data-index="${i}" value="${slide.title.replace(/"/g, '&quot;')}">
                    </div>
                    <div class="preview-field">
                        <label>内容（Markdown）</label>
                        <textarea class="preview-content-input" data-index="${i}" rows="8">${slide.content}</textarea>
                    </div>
                    <div class="preview-field">
                        <label>プレビュー</label>
                        <div class="preview-rendered" id="rendered-${i}"></div>
                    </div>
                `;
                container.appendChild(card);

                // Markdownプレビューを初期レンダリング
                const rendered = card.querySelector(`#rendered-${i}`);
                rendered.innerHTML = marked.parse(slide.content || '');

                // 内容変更時にプレビューを更新
                const contentInput = card.querySelector('.preview-content-input');
                contentInput.addEventListener('input', () => {
                    rendered.innerHTML = marked.parse(contentInput.value || '');
                });
            });

            showStep('preview');
            window.scrollTo(0, 0);
        }

        // === プレビューからスライドデータを収集 ===
        function collectEditedSlides() {
            const titles = document.querySelectorAll('.preview-title-input');
            const contents = document.querySelectorAll('.preview-content-input');
            return currentSlides.map((slide, i) => ({
                ...slide,
                title: titles[i].value,
                content: contents[i].value
            }));
        }

        // === 設定モーダル ===
        const modalOverlay = document.getElementById('modalOverlay');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const promptTextarea = document.getElementById('promptTextarea');

        document.getElementById('btnSettings').addEventListener('click', async () => {
            await defaultPromptPromise;
            apiKeyInput.value = getApiKey();
            promptTextarea.value = getEffectivePrompt();
            modalOverlay.classList.add('active');
        });

        document.getElementById('modalClose').addEventListener('click', () => {
            modalOverlay.classList.remove('active');
        });

        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) modalOverlay.classList.remove('active');
        });

        document.querySelectorAll('.modal-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.modal-tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('modal-tab-' + tab.dataset.modalTab).classList.add('active');
            });
        });

        // APIキー操作
        document.getElementById('btnToggleKey').addEventListener('click', () => {
            apiKeyInput.type = apiKeyInput.type === 'password' ? 'text' : 'password';
        });

        document.getElementById('btnSaveKey').addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (!key) { showStatus('apiKeyStatus', 'APIキーを入力してください', 'error'); return; }
            if (!key.startsWith('sk-')) { showStatus('apiKeyStatus', 'APIキーは "sk-" で始まる必要があります', 'error'); return; }
            localStorage.setItem('openai_api_key', key);
            showStatus('apiKeyStatus', '保存しました', 'success');
            updateApiWarning();
        });

        document.getElementById('btnDeleteKey').addEventListener('click', () => {
            localStorage.removeItem('openai_api_key');
            apiKeyInput.value = '';
            showStatus('apiKeyStatus', '削除しました', 'success');
            updateApiWarning();
        });

        // プロンプト操作
        document.getElementById('btnSavePrompt').addEventListener('click', () => {
            const prompt = promptTextarea.value.trim();
            if (!prompt) { showStatus('promptStatus', 'プロンプトを入力してください', 'error'); return; }
            localStorage.setItem('custom_prompt', prompt);
            showStatus('promptStatus', '保存しました', 'success');
        });

        document.getElementById('btnResetPrompt').addEventListener('click', () => {
            localStorage.removeItem('custom_prompt');
            promptTextarea.value = defaultPrompt;
            showStatus('promptStatus', 'デフォルトに戻しました', 'success');
        });

        function showStatus(elementId, msg, type) {
            const status = document.getElementById(elementId);
            status.textContent = msg;
            status.className = 'api-key-status ' + type;
            status.style.display = 'block';
            setTimeout(() => status.style.display = 'none', 3000);
        }

        // === メイン画面タブ切替 ===
        document.querySelectorAll('.tabs .tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
                document.getElementById('inputType').value = tab.dataset.tab;
            });
        });

        document.getElementById('pdfFile').addEventListener('change', (e) => {
            document.getElementById('fileLabel').textContent = e.target.files[0]?.name || 'クリックしてPDFを選択';
        });

        // === フォーム送信 → プレビュー ===
        document.getElementById('generateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const btn = document.getElementById('btnGenerate');

            const apiKey = getApiKey();
            if (!apiKey) {
                error.textContent = 'APIキーが設定されていません。右上の歯車アイコンから設定してください。';
                error.style.display = 'block';
                return;
            }

            error.style.display = 'none';
            loading.style.display = 'block';
            btn.disabled = true;

            try {
                const formData = new FormData(e.target);
                formData.append('api_key', apiKey);
                const customPrompt = getCustomPrompt();
                if (customPrompt) formData.append('custom_prompt', customPrompt);

                const resp = await fetch('/generate', { method: 'POST', body: formData });
                const data = await resp.json();

                if (data.error) {
                    error.textContent = data.error;
                    error.style.display = 'block';
                } else {
                    renderPreview(data.slides);
                }
            } catch (err) {
                error.textContent = '通信エラーが発生しました。もう一度お試しください。';
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                btn.disabled = false;
            }
        });

        // === プレビュー → 入力に戻る ===
        document.getElementById('btnBackToInput').addEventListener('click', () => {
            showStep('input');
        });

        // === プレビュー → スライド化 ===
        document.getElementById('btnToSlides').addEventListener('click', () => {
            const edited = collectEditedSlides();
            sessionStorage.setItem('slides', JSON.stringify(edited));
            window.location.href = '/slides';
        });
    </script>
</body>
</html>
